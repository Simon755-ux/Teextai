<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Kunskapstest</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;
        
        // Lucide icons som SVG komponenter
        const Brain = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>
                <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/>
                <path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/>
                <path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/>
                <path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/>
                <path d="M3.477 10.896a4 4 0 0 1 .585-.396"/>
                <path d="M19.938 10.5a4 4 0 0 1 .585.396"/>
                <path d="M6 18a4 4 0 0 1-1.967-.516"/>
                <path d="M19.967 17.484A4 4 0 0 1 18 18"/>
            </svg>
        );
        
        const ArrowRight = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
            </svg>
        );
        
        const CheckCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/>
            </svg>
        );
        
        const XCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>
            </svg>
        );
        
        const RefreshCw = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>
            </svg>
        );
        
        const BookOpen = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
        );
        
        const FileText = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/>
            </svg>
        );
        
        const Download = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );
        
        const Upload = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>
            </svg>
        );
        
        const Plus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12h14"/><path d="M12 5v14"/>
            </svg>
        );
        
        const Minus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12h14"/>
            </svg>
        );
        
        const Key = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4"/><path d="m21 2-9.6 9.6"/><circle cx="7.5" cy="15.5" r="5.5"/>
            </svg>
        );

        function QuizGenerator() {
          const [text, setText] = useState('');
          const [stage, setStage] = useState('input');
          const [questions, setQuestions] = useState([]);
          const [currentQuestion, setCurrentQuestion] = useState(0);
          const [userAnswer, setUserAnswer] = useState('');
          const [answers, setAnswers] = useState([]);
          const [loading, setLoading] = useState(false);
          const [numQuestions, setNumQuestions] = useState(5);
          const [apiKey, setApiKey] = useState('');
          const [showApiKeyInput, setShowApiKeyInput] = useState(false);

          const generateQuestions = async () => {
            if (!text.trim()) return;
            
            if (!apiKey.trim()) {
              setShowApiKeyInput(true);
              alert('Du behöver ange en Anthropic API-nyckel först');
              return;
            }
            
            setLoading(true);
            
            try {
              const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "x-api-key": apiKey,
                  "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                  model: "claude-sonnet-4-20250514",
                  max_tokens: 2000,
                  messages: [
                    {
                      role: "user",
                      content: `Baserat på följande text, generera exakt ${numQuestions} frågor som testar förståelsen av innehållet. Svara ENDAST med JSON i detta format (ingen annan text):
[
  {
    "question": "frågan här",
    "answer": "kortfattat korrekt svar"
  }
]

Text att skapa frågor från:
${text}`
                    }
                  ],
                })
              });

              if (!response.ok) {
                throw new Error('API-anrop misslyckades. Kontrollera din API-nyckel.');
              }

              const data = await response.json();
              
              const fullText = data.content
                .map(item => item.type === "text" ? item.text : "")
                .join("")
                .trim();
              
              const cleanJson = fullText.replace(/```json|```/g, '').trim();
              const generatedQuestions = JSON.parse(cleanJson);
              
              setQuestions(generatedQuestions);
              setStage('quiz');
              setCurrentQuestion(0);
              setAnswers([]);
            } catch (error) {
              console.error('Fel vid generering av frågor:', error);
              alert('Något gick fel. Kontrollera din API-nyckel och försök igen.');
            } finally {
              setLoading(false);
            }
          };

          const downloadQuiz = () => {
            if (!text.trim()) return;
            
            const quizData = {
              text: text,
              questions: questions.length > 0 ? questions : [],
              numQuestions: numQuestions,
              createdAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(quizData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          };

          const uploadQuiz = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const quizData = JSON.parse(e.target.result);
                setText(quizData.text);
                setQuestions(quizData.questions || []);
                setNumQuestions(quizData.numQuestions || quizData.questions?.length || 5);
                if (quizData.questions && quizData.questions.length > 0) {
                  setStage('quiz');
                  setCurrentQuestion(0);
                  setAnswers([]);
                }
              } catch (error) {
                console.error('Fel vid uppladdning:', error);
                alert('Kunde inte läsa filen. Kontrollera att det är en giltig quiz-fil.');
              }
            };
            reader.readAsText(file);
          };

          const submitAnswer = () => {
            const newAnswers = [...answers, {
              question: questions[currentQuestion].question,
              userAnswer: userAnswer,
              correctAnswer: questions[currentQuestion].answer,
              isCorrect: userAnswer.toLowerCase().trim() === questions[currentQuestion].answer.toLowerCase().trim()
            }];
            
            setAnswers(newAnswers);
            setUserAnswer('');
            
            if (currentQuestion < questions.length - 1) {
              setCurrentQuestion(currentQuestion + 1);
            } else {
              setStage('results');
            }
          };

          const restartAll = () => {
            setText('');
            setStage('input');
            setQuestions([]);
            setCurrentQuestion(0);
            setAnswers([]);
            setUserAnswer('');
            setNumQuestions(5);
          };

          const retryMistakes = () => {
            const wrongAnswers = answers.filter(a => !a.isCorrect);
            const wrongQuestions = wrongAnswers.map(a => ({
              question: a.question,
              answer: a.correctAnswer
            }));
            
            setQuestions(wrongQuestions);
            setCurrentQuestion(0);
            setAnswers([]);
            setUserAnswer('');
            setStage('quiz');
          };

          const newText = () => {
            setText('');
            setStage('input');
            setQuestions([]);
            setCurrentQuestion(0);
            setAnswers([]);
            setUserAnswer('');
          };

          const correctCount = answers.filter(a => a.isCorrect).length;
          const totalCount = answers.length;
          const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

          if (stage === 'input') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                <div className="max-w-3xl mx-auto">
                  <div className="bg-white rounded-2xl shadow-xl p-8">
                    <div className="flex items-center gap-3 mb-6">
                      <div className="w-10 h-10 text-indigo-600"><Brain /></div>
                      <h1 className="text-3xl font-bold text-gray-800">AI Kunskapstest</h1>
                    </div>
                    
                    <p className="text-gray-600 mb-6">
                      Klistra in en text så genererar AI frågor för att testa din förståelse.
                    </p>
                    
                    {showApiKeyInput && (
                      <div className="mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                        <div className="flex items-start gap-3 mb-3">
                          <div className="w-5 h-5 text-blue-600 mt-0.5"><Key /></div>
                          <div className="flex-1">
                            <h3 className="font-semibold text-blue-900 mb-2">Anthropic API-nyckel krävs</h3>
                            <p className="text-sm text-blue-700 mb-3">
                              För att använda denna app behöver du en API-nyckel från Anthropic. 
                              Skaffa en på <a href="https://console.anthropic.com/" target="_blank" className="underline">console.anthropic.com</a>
                            </p>
                            <input
                              type="password"
                              value={apiKey}
                              onChange={(e) => setApiKey(e.target.value)}
                              placeholder="sk-ant-api03-..."
                              className="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            />
                            <p className="text-xs text-blue-600 mt-2">
                              Din API-nyckel lagras endast lokalt i din webbläsare
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {!showApiKeyInput && (
                      <button
                        onClick={() => setShowApiKeyInput(true)}
                        className="mb-6 flex items-center gap-2 text-sm text-indigo-600 hover:text-indigo-800"
                      >
                        <div className="w-4 h-4"><Key /></div>
                        Ange API-nyckel
                      </button>
                    )}
                    
                    <textarea
                      value={text}
                      onChange={(e) => setText(e.target.value)}
                      placeholder="Skriv eller klistra in din text här..."
                      className="w-full h-64 p-4 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none resize-none"
                    />
                    
                    <div className="mt-6 flex items-center gap-4">
                      <div className="flex items-center gap-3 bg-gray-100 rounded-lg p-2">
                        <button
                          onClick={() => setNumQuestions(Math.max(1, numQuestions - 1))}
                          className="p-2 hover:bg-gray-200 rounded transition"
                        >
                          <div className="w-5 h-5 text-gray-700"><Minus /></div>
                        </button>
                        <span className="font-semibold text-gray-800 w-16 text-center">
                          {numQuestions} frågor
                        </span>
                        <button
                          onClick={() => setNumQuestions(numQuestions + 1)}
                          className="p-2 hover:bg-gray-200 rounded transition"
                        >
                          <div className="w-5 h-5 text-gray-700"><Plus /></div>
                        </button>
                      </div>
                      
                      {numQuestions > 20 && (
                        <p className="text-sm text-orange-600 flex-1">
                          ⚠️ AI:n kan ha svårt att hitta på unika frågor över 20 stycken
                        </p>
                      )}
                    </div>
                    
                    <div className="mt-6 flex justify-between items-center gap-4">
                      <div className="flex gap-3">
                        <label className="cursor-pointer">
                          <input
                            type="file"
                            accept=".json"
                            onChange={uploadQuiz}
                            className="hidden"
                          />
                          <div className="flex items-center gap-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">
                            <div className="w-5 h-5"><Upload /></div>
                            Ladda upp quiz
                          </div>
                        </label>
                        
                        <button
                          onClick={downloadQuiz}
                          disabled={!text.trim()}
                          className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                          <div className="w-5 h-5"><Download /></div>
                          Ladda ner
                        </button>
                      </div>
                      
                      <button
                        onClick={generateQuestions}
                        disabled={!text.trim() || loading}
                        className="bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2"
                      >
                        {loading ? 'Genererar...' : 'Starta Quiz'}
                        <div className="w-5 h-5"><ArrowRight /></div>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (stage === 'quiz') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                <div className="max-w-2xl mx-auto">
                  <div className="bg-white rounded-2xl shadow-xl p-8">
                    <div className="mb-6">
                      <div className="flex justify-between items-center mb-4">
                        <span className="text-sm font-semibold text-indigo-600">
                          Fråga {currentQuestion + 1} av {questions.length}
                        </span>
                        <div className="flex gap-1">
                          {questions.map((_, idx) => (
                            <div
                              key={idx}
                              className={`w-8 h-2 rounded ${
                                idx < currentQuestion ? 'bg-indigo-600' :
                                idx === currentQuestion ? 'bg-indigo-400' :
                                'bg-gray-200'
                              }`}
                            />
                          ))}
                        </div>
                      </div>
                      
                      <h2 className="text-2xl font-bold text-gray-800 mb-6">
                        {questions[currentQuestion].question}
                      </h2>
                      
                      <input
                        type="text"
                        value={userAnswer}
                        onChange={(e) => setUserAnswer(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && userAnswer.trim() && submitAnswer()}
                        placeholder="Skriv ditt svar här..."
                        className="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                        autoFocus
                      />
                      
                      <button
                        onClick={submitAnswer}
                        disabled={!userAnswer.trim()}
                        className="mt-6 w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                      >
                        {currentQuestion < questions.length - 1 ? 'Nästa fråga' : 'Visa resultat'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (stage === 'results') {
            const wrongAnswers = answers.filter(a => !a.isCorrect);
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                <div className="max-w-3xl mx-auto">
                  <div className="bg-white rounded-2xl shadow-xl p-8">
                    <div className="text-center mb-8">
                      <div className={`inline-flex items-center justify-center w-20 h-20 rounded-full mb-4 ${
                        percentage >= 70 ? 'bg-green-100' : 'bg-orange-100'
                      }`}>
                        <span className="text-3xl font-bold text-gray-800">{percentage}%</span>
                      </div>
                      <h2 className="text-3xl font-bold text-gray-800 mb-2">Quiz klar!</h2>
                      <p className="text-gray-600">
                        Du fick {correctCount} av {totalCount} rätt
                      </p>
                    </div>

                    <div className="space-y-4 mb-8">
                      {answers.map((answer, idx) => (
                        <div
                          key={idx}
                          className={`p-4 rounded-lg border-2 ${
                            answer.isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'
                          }`}
                        >
                          <div className="flex items-start gap-3">
                            <div className={`w-6 h-6 flex-shrink-0 mt-1 ${
                              answer.isCorrect ? 'text-green-600' : 'text-red-600'
                            }`}>
                              {answer.isCorrect ? <CheckCircle /> : <XCircle />}
                            </div>
                            <div className="flex-1">
                              <p className="font-semibold text-gray-800 mb-2">{answer.question}</p>
                              {!answer.isCorrect && (
                                <>
                                  <p className="text-sm text-red-700 mb-1">
                                    Ditt svar: {answer.userAnswer}
                                  </p>
                                  <p className="text-sm text-green-700">
                                    Rätt svar: {answer.correctAnswer}
                                  </p>
                                </>
                              )}
                              {answer.isCorrect && (
                                <p className="text-sm text-green-700">
                                  {answer.userAnswer}
                                </p>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <button
                        onClick={restartAll}
                        className="flex items-center justify-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700"
                      >
                        <div className="w-5 h-5"><RefreshCw /></div>
                        Kör om allt
                      </button>
                      
                      {wrongAnswers.length > 0 && (
                        <button
                          onClick={retryMistakes}
                          className="flex items-center justify-center gap-2 bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-700"
                        >
                          <div className="w-5 h-5"><BookOpen /></div>
                          Öva misstag ({wrongAnswers.length})
                        </button>
                      )}
                      
                      <button
                        onClick={newText}
                        className="flex items-center justify-center gap-2 bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700"
                      >
                        <div className="w-5 h-5"><FileText /></div>
                        Ny text
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          return null;
        }

        ReactDOM.render(<QuizGenerator />, document.getElementById('root'));
    </script>
</body>
</html>
